defaults: &defaults
  working_directory: /srv/jekyll/
version: 2
jobs:
  build:
    <<: *defaults
    docker:
      - image: jekyll/jekyll:pages
    steps:
      - checkout
      - run:
          name: Posts filename check
          command: find ./_posts/ -type f | grep -ve "[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}-.*\.md" -
      - run:
          name: Jekyll build
          command: jekyll build
      - run:
          name: HTMLProofer tests
          command: |
            /usr/gem/bin/htmlproofer ./_site \
              --allow-hash-href \
              --check-html \
              --disable-external \
              --url-swap '^/blog:'
      - persist_to_workspace:
          root: ./
          paths:
            - _site
workflows:
  version: 2
  test-build:
    jobs:
      - build